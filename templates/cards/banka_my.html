{% extends 'layout.html' %}
{% load static %}

{% block title %}–ë–∞–Ω–∫–∞ –Ω–∞–∫–æ–ø–∏—á—É–≤–∞–Ω–Ω—è{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'cards/css/banka_my.css' %}">

{% if user.is_authenticated %}
    <a href="{% url 'cards:banka' pk=request.resolver_match.kwargs.pk %}" class="back-button">‚Üê –ù–∞–∑–∞–¥</a>

    <div class="container">
        <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–∞–Ω–∫–µ -->
        <div class="banka-info-block">
            <h1>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –í–∞—à—É –Ω–∞–∫–æ–ø–∏—á—É–≤–∞–ª—å–Ω—É –±–∞–Ω–∫—É</h1>

            {% if banka %}
                <div class="banka-info">
                    <p><strong>–ù–∞–∑–≤–∞:</strong> {{ banka.name }}</p>
                    <p><strong>–û–ø–∏—Å:</strong> {{ banka.description }}</p>
                    <p><strong>–¶—ñ–ª—å –Ω–∞–∫–æ–ø–∏—á—É–≤–∞–Ω–Ω—è:</strong> {{ banka.goal }} –≥—Ä–Ω</p>
                    <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> <span id="balance-text">{{ banka.balance }}</span> –≥—Ä–Ω</p>
                    <p><strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–ø–æ–≤–Ω–µ–Ω—å:</strong> {{ banka.deposit_count }}</p>
                    <p><strong>–î–∞—Ç–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è:</strong> {{ banka.opening_date }}</p>
                    {% if banka.closing_date %}
                        <p><strong>–î–∞—Ç–∞ –∑–∞—á–∏–Ω–µ–Ω–Ω—è:</strong> {{ banka.closing_date }}</p>
                    {% endif %}
                    <p><strong>–•–µ—à-–∫–æ–¥:</strong> {{ banka.hash_code }}</p>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="banka-buttons">
                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏ -->
                        <form method="post" action="{% url 'cards:close_banka' pk=banka.id %}">
                            {% csrf_token %}
                            <button type="submit" class="banka-btn close-banka-btn" onclick="showConfirmation(event)">
                                <img src="https://cdn-icons-png.flaticon.com/512/1828/1828843.png" alt="–ó–∞–∫—Ä–∏—Ç–∏">
                                –ó–∞–∫—Ä–∏—Ç–∏ –±–∞–Ω–∫—É
                            </button>
                        </form>

                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <a href="{% url 'cards:edit_banka' pk=banka.id %}" class="banka-btn edit-banka-btn">
                            <img src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png" alt="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                            –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –±–∞–Ω–∫—É
                        </a>

                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–Ω—è—Ç–∏—è –¥–µ–Ω–µ–≥ -->
                        <button class="banka-btn withdraw-banka-btn" id="withdraw-banka-btn">
                            <img src="https://cdn-icons-png.flaticon.com/512/2856/2856683.png" alt="–ó–Ω—è—Ç–∏ –≥—Ä–æ—à—ñ"> 
                            –ó–Ω—è—Ç–∏ –≥—Ä–æ—à—ñ
                        </button>                                          
                    </div>
                </div>
            {% else %}
                <p class="no-banka-message">–£ –≤–∞—Å –Ω–µ–º–∞—î –Ω–∞–∫–æ–ø–∏—á—É–≤–∞–ª—å–Ω–æ—ó –±–∞–Ω–∫–∏. –í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–æ–≤—É –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ <a href="{% url 'cards:open_banka' pk=request.resolver_match.kwargs.pk %}">–≤—ñ–¥–∫—Ä–∏—Ç–∏ –±–∞–Ω–∫—É</a>.</p>
            {% endif %}
        </div>

        <!-- –ë–ª–æ–∫ —Å –≤–∏–∑—É–∞–ª—å–Ω–æ–π –±–∞–Ω–∫–æ–π -->
        {% if banka %}
        <div class="banka-visual-block">
            <p class="goal-text">{{ banka.goal }} –≥—Ä–Ω</p>

            <div class="banka-glass">
                <div class="banka-liquid" style="height: {% widthratio banka.balance banka.goal 100 %}%;"></div>
            </div>

            <p class="balance-text" id="balance-text-visual">{{ banka.balance }} –≥—Ä–Ω</p>
        </div>
        {% endif %}

    </div>

    {% if banka %}
        <script>
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –±–∞–Ω–∫–∏
            function showConfirmation(event) {
                event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ)
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                if (confirm("–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –∑–∞–∫—Ä–∏—Ç–∏ –±–∞–Ω–∫—É? –¶–µ –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏!")) {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                    event.target.closest('form').submit();
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                const withdrawButton = document.getElementById("withdraw-banka-btn");
                
                if (withdrawButton) {
                    withdrawButton.addEventListener("click", function () {
                        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–Ω—è—Ç–∏–µ–º –¥–µ–Ω–µ–≥
                        if (confirm("–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –∑–Ω—è—Ç–∏ –≤—Å—ñ –≥—Ä–æ—à—ñ –∑ –Ω–∞–∫–æ–ø–∏—á—É–≤–∞–ª—å–Ω–æ—ó –±–∞–Ω–∫–∏?")) {
                            fetch("{% url 'cards:withdraw_banka' pk=banka.id %}", {
                                method: "POST",
                                headers: {
                                    "X-CSRFToken": "{{ csrf_token }}",
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({})  // –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("–ì—Ä–æ—à—ñ —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –Ω–∞ –≤–∞—à—É –æ—Å–Ω–æ–≤–Ω—É –∫–∞—Ä—Ç–∫—É!");

                                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                                    document.getElementById("balance-text").innerText = "0.00 –≥—Ä–Ω";
                                    document.getElementById("balance-text-visual").innerText = "0.00 –≥—Ä–Ω";
                                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–Ω—è—Ç–∏—è –¥–µ–Ω–µ–≥
                                    withdrawButton.style.display = "none";
                                } else {
                                    alert("–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.");
                                }
                            });
                        }
                    });
                } else {
                    // –ï—Å–ª–∏ –±–∞–Ω–∫–∞ –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–Ω—è—Ç–∏ –≥—Ä–æ—à—ñ"
                    console.log("–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞–∫–æ–ø–∏—á—É–≤–∞–ª—å–Ω–æ—ó –±–∞–Ω–∫–∏.");
                }
            });
        </script>
    {% else %}
        <script>
            // –ï—Å–ª–∏ –±–∞–Ω–∫–∞ –Ω–µ—Ç, —Å–∫—Ä–∏–ø—Ç –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
            document.addEventListener("DOMContentLoaded", function () {
                const withdrawButton = document.getElementById("withdraw-banka-btn");
                withdrawButton.style.display = "none";  // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–Ω—è—Ç–∏ –≥—Ä–æ—à—ñ"
            });
        </script>
    {% endif %}

{% else %}
    <div class="auth-message">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828843.png" alt="–•—Ä–µ—Å—Ç" class="error-icon">
        <h1>–û–π –ª–∏—Ö–æ, —Å—Ö–æ–∂–µ –≤–∞–º —Å–ø–æ—á–∞—Ç–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è... ü´£</h1>
    </div>
{% endif %}
{% endblock %}