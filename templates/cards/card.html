{% extends 'layout.html' %}
{% load static %}

{% block title %} Карта {{ card.card_number }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'cards/css/style_card.css' %}">

<div class="features">
    {% if request.user.is_authenticated %}
        <h1>Ваша картка:</h1>
        <div class="card-section">
            <!-- Кнопка "Інші картки" -->
            <a href="{% url 'cards' %}" class="button-cards"><i class="fas fa-address-card"></i> Інші картки</a>
            
            <!-- Обертка для карточки и блока баланса -->
            <div class="card-wrapper">
                <!-- Обертка для карточки -->
                <div class="card-container">
                    <div class="card" id="card">
                        <div class="card-front">
                            <div class="card-number">{{ card.card_number }}</div>
                            <div class="card-expiry">Термін: {{ card.expiry_date }}</div>
                        </div>
                        <div class="card-back">
                            <div class="card-number">{{ card.card_number }}</div>
                            <div class="card-cvv">CVV: {{ card.cvv }}</div>
                        </div>
                    </div>
                    <button class="flip-button" id="flipButton" onclick="toggleCVV()">
                        <span class="arrow-container">&#x21bb;</span>
                        <span class="button-text" id="flipButtonText">Показати CVV</span>
                    </button>
                </div>

                <!-- Блок баланса справа от карточки -->
                <div class="balance-block">
                    <div class="balance-info">
                        <span class="balance-amount">{{ card.balance }} грн</span>
                        <span class="exchange-rate" id="exchangeRate"></span>
                    </div>
                    <hr class="divider">
                    <div class="action-buttons">
                        <!-- Заменили <button> на <a> -->
                        <a href="#" class="replenish-button">Поповнити рахунок +</a>
                        <div class="button-divider"></div>
                        <a href="transfer" class="send-button">Відправити</a>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <div class="tabs">
            <button class="tab-button active" data-tab="transactions">Транзакції</button>
            <button class="tab-button" data-tab="services">Послуги</button>
            <button class="tab-button" data-tab="rates">Курс</button>
        </div>

        <div class="tab-content" id="transactions" style="display: block;">
            <h2>Транзакції</h2>
            {% if transactions %}
                <ul>
                    {% for transaction in transactions %}
                        <li>
                            <strong>Получатель:</strong> {{ transaction.recipient.username }}<br>
                            <strong>Сумма:</strong> {{ transaction.amount }} ₽<br>
                            <strong>Дата:</strong> {{ transaction.date }}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Нет транзакций для этой карты.</p>
            {% endif %}
        </div>

        <div class="tab-content" id="services" style="display: none;">
            <div class="services-buttons">
                <a href="mobile" class="service-button" style="--color-start: #6a1b9a; --color-end: #ab47bc;">Поповнення мобільного</a>
                <a href="#" class="service-button" style="--color-start: #1565c0; --color-end: #42a5f5;">Страхування</a>
                <a href="#" class="service-button" style="--color-start: #2e7d32; --color-end: #66bb6a;">Банка накопичування</a>
                <a href="#" class="service-button" style="--color-start: #ef6c00; --color-end: #ffb74d;">Авто</a>
                <a href="#" class="service-button" style="--color-start: #c62828; --color-end: #ef5350;">Кредит</a>
                <a href="#" class="service-button" style="--color-start: #6d4c41; --color-end: #a1887f;">Поїзд</a>
                <a href="#" class="service-button" style="--color-start: #424242; --color-end: #757575;">Закрити картку</a>
            </div>
        </div>

        <div class="tab-content" id="rates" style="display: none;">
            <h2>Курс</h2>
            <p>Информация о курсах валют будет добавлена позже.</p>
        </div>
        
    {% else %}
        <h1>Ласкаво просимо</h1>
        <p>Будь ласка, <a href="{% url 'home' %}">увійдіть</a> або <a href="{% url 'home' %}">зареєструйтесь</a>.</p>
    {% endif %}
</div>

<script>
    // Получаем все табы и их контент
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    // Добавляем обработчик события для каждой кнопки таба
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Скрываем все табы
            tabContents.forEach(content => {
                content.style.display = 'none';
            });

            // Убираем класс активного таба
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // Показываем нужный таб
            const targetTabContent = document.getElementById(tab.dataset.tab);
            targetTabContent.style.display = 'block';

            // Добавляем класс активного таба
            tab.classList.add('active');
        });
    });

    // Получаем элементы для переворота карточки
    const flipButton = document.getElementById('flipButton');
    const card = document.getElementById('card');

    // Добавляем обработчик события для кнопки переворота
    flipButton.addEventListener('click', () => {
        card.classList.toggle('flipped'); // Переворачиваем карточку
    });

    let isCVVVisible = false;

    // Функция для переключения текста на кнопке
    function toggleCVV() {
        const flipButtonText = document.getElementById("flipButtonText");

        // Переключаем текст кнопки в зависимости от состояния карточки
        if (isCVVVisible) {
            flipButtonText.textContent = "Показати CVV"; // Меняем на "Показати CVV"
        } else {
            flipButtonText.textContent = "Приховати CVV"; // Меняем на "Приховати CVV"
        }

        // Переключаем состояние видимости CVV
        isCVVVisible = !isCVVVisible;
    }

    async function fetchExchangeRate() {
        try {
            const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTRUB');
            const data = await response.json();
            const exchangeRateElement = document.getElementById('exchangeRate');
            exchangeRateElement.textContent = `1 USD = ${parseFloat(data.price).toFixed(2)} грн`;
        } catch (error) {
            console.error('Ошибка при получении курса валют:', error);
        }
    }
    document.addEventListener('DOMContentLoaded', fetchExchangeRate);
</script>
{% endblock %}
