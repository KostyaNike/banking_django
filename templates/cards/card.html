{% extends 'layout.html' %}
{% load static %}

{% block title %} –ö–∞—Ä—Ç–∞ {{ card.card_number }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'cards/css/style_card.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

{% if user.is_authenticated %}
    <div class="features">
        <h1>–í–∞—à–∞ –∫–∞—Ä—Ç–∫–∞:</h1>
        <div class="card-section">
            <!-- –ö–Ω–æ–ø–∫–∞ "–Ü–Ω—à—ñ –∫–∞—Ä—Ç–∫–∏" -->
            <a href="{% url 'cards:cards' %}" class="button-cards"><i class="fas fa-address-card"></i> –Ü–Ω—à—ñ –∫–∞—Ä—Ç–∫–∏</a>
            
            <!-- –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –±–ª–æ–∫–∞ –±–∞–ª–∞–Ω—Å–∞ -->
            <div class="card-wrapper">
                <!-- –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                <div class="card-container">
                    <div class="card" id="card">
                        <div class="card-front">
                            <div class="card-number">
                                <span class="visible-part">{{ card.card_number|slice:":2" }}</span>
                                <span class="masked-part">**********</span>
                                <span class="visible-part">{{ card.card_number|slice:"12:" }}</span>
                            </div>                                                        
                            <div class="card-expiry">–¢–µ—Ä–º—ñ–Ω: {{ card.expiry_date }}</div>
                        </div>
                        <div class="card-back">
                            <div class="card-number" id="cardNumberFull">{{ card.card_number }}</div>
                            <div class="card-cvv">CVV: {{ card.cvv }}</div>
                        </div>
                    </div>
                    <button class="flip-button" id="flipButton" onclick="toggleCVV()">
                        <span class="arrow-container">&#x21bb;</span>
                        <span class="button-text" id="flipButtonText">–ü–æ–∫–∞–∑–∞—Ç–∏ CVV</span>
                    </button>
                </div>

                <!-- –ë–ª–æ–∫ –±–∞–ª–∞–Ω—Å–∞ —Å–ø—Ä–∞–≤–∞ –æ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                <div class="balance-block">
                    <div class="balance-info">
                        <span class="balance-amount">{{ card.balance }} –≥—Ä–Ω</span>
                        <span class="exchange-rate" id="exchangeRate"></span>
                        <p class="credit-info">–ö—Ä–µ–¥–∏—Ç: {{ user.credit_balance }} –≥—Ä–Ω</p>
                    </div>
                    <hr class="divider">
                    <div class="action-buttons">
                        <!-- –ó–∞–º–µ–Ω–∏–ª–∏ <button> –Ω–∞ <a> -->
                        <a href="#" class="replenish-button">–ü–æ–ø–æ–≤–Ω–∏—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫ +</a>
                        <div class="button-divider"></div>
                        <a href="transfer" class="send-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</a>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <div class="tabs">
            <button class="tab-button active" data-tab="services">–ü–æ—Å–ª—É–≥–∏</button>
            <button class="tab-button" data-tab="transactions">–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó</button>
            <button class="tab-button" data-tab="rates">–ö—É—Ä—Å</button>
        </div>

        <div class="tab-content" id="services" style="display: block;">
            <div class="services-buttons">
                <a href="mobile" class="service-button" style="--color-start: #8311ca;">
                    <i class="fas fa-mobile-alt"></i> –ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ
                </a>
                <a href="credit" class="service-button" style="--color-start: #ac1d1d;">
                    <i class="fas fa-credit-card"></i> –ö—Ä–µ–¥–∏—Ç
                </a>
                <a href="auto" class="service-button" style="--color-start: #ef6c00;">
                    <i class="fas fa-car"></i> –ê–≤—Ç–æ
                </a>
                <a href="close-card" class="service-button" style="--color-start: #5b5b5b;">
                    <i class="fas fa-times-circle"></i> –ó–∞–∫—Ä–∏—Ç–∏ –∫–∞—Ä—Ç–∫—É
                </a>
                <a href="banka" class="service-button" style="--color-start: #2e7d32;">
                    <i class="fas fa-piggy-bank"></i> –ë–∞–Ω–∫–∞ –Ω–∞–∫–æ–ø–∏—á—É–≤–∞–Ω–Ω—è
                </a>
                <a href="insurance" class="service-button" style="--color-start: #1565c0;">
                    <i class="fas fa-shield-alt"></i> –°—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è
                </a>
                <a href="train" class="service-button" style="--color-start: #694f47;">
                    <i alt="–ò–∫–æ–Ω–∫–∞" style="width: 24px; height: 24px;"></i> –ü–æ—Ç—É–∂–Ω–æ–º–µ—Ç—Ä
                </a>
            </div>
        </div>

        <div class="tab-content" id="transactions" style="display: none;">
            {% if transactions %}
                <ul class="transaction-list">
                    {% for transaction in transactions %}
                        <li class="transaction-item">
                            <div class="transaction-header">
                                <strong class="transaction-recipient">–û—Ç—Ä–∏–º—É–≤–∞—á:</strong> <span class="recipient-name">{{ transaction.recipient.username }}</span>
                            </div>
                            <div class="transaction-details">
                                <strong class="transaction-amount">–°—É–º–∞:</strong> <span class="amount-value"><b>{{ transaction.amount }} </b>‚Ç¥</span>
                                <strong class="transaction-date">–î–∞—Ç–∞:</strong> <span class="transaction-date-value"><b>{{ transaction.date }}</b></span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="no-transactions-message">–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤—ñ–¥—Å—É—Ç–Ω—ñ.</p>
            {% endif %}
        </div>

        <div class="tab-content" id="rates" style="display: none;">
            <h2>–ö—É—Ä—Å</h2>
            <div id="exchangeRates" class="exchange-rates"></div>
            <button id="scrollDownButton" class="scroll-button" onclick="scrollToBottom()">&#x2193;</button>
        </div>
    </div>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–∞–±—ã –∏ –∏—Ö –∫–æ–Ω—Ç–µ–Ω—Ç
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        let scrollButton;
        let lastScrollPosition = 0; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∞

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏ —Ç–∞–±–∞
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã
                tabContents.forEach(content => {
                    content.style.display = 'none';
                });

                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–±–∞
                tabs.forEach(tab => {
                    tab.classList.remove('active');
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ç–∞–±
                const targetTabContent = document.getElementById(tab.dataset.tab);
                targetTabContent.style.display = 'block';

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–±–∞
                tab.classList.add('active');

                // –ï—Å–ª–∏ —ç—Ç–æ –≤–∫–ª–∞–¥–∫–∞ "–ö—É—Ä—Å", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                if (tab.dataset.tab === 'rates') {
                    showScrollButton();
                    fetchExchangeRates();
                } else {
                    hideScrollButton();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑
        function showScrollButton() {
            if (!scrollButton) {
                scrollButton = document.createElement('button');
                scrollButton.id = 'scrollDownButton';
                scrollButton.classList.add('scroll-button');
                scrollButton.innerHTML = '&#x2193;';
                scrollButton.onclick = scrollToBottom;
                document.body.appendChild(scrollButton);
            }
            scrollButton.style.display = 'block';
            setTimeout(() => scrollButton.classList.add('show'), 100);
            window.addEventListener('scroll', toggleScrollButton);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–∫–∏
        function hideScrollButton() {
            if (scrollButton) {
                scrollButton.classList.remove('show');
                setTimeout(() => scrollButton.style.display = 'none', 300);
                window.removeEventListener('scroll', toggleScrollButton);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∫–Ω–æ–ø–∫–∏
        function toggleScrollButton() {
            const currentScrollPosition = window.scrollY; // –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞

            // –ï—Å–ª–∏ –º—ã –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–≤–µ—Ä—Ö (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ–∑–∏—Ü–∏–µ–π)
            if (currentScrollPosition < lastScrollPosition) {
                // –ï—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∏–ª–∏ –≤–≤–µ—Ä—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                scrollButton.classList.add('show');
            } else {
                // –ï—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∏–ª–∏ –≤–Ω–∏–∑, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                scrollButton.classList.remove('show');
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
            lastScrollPosition = currentScrollPosition;
        }

        window.addEventListener('scroll', toggleScrollButton);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
        async function fetchExchangeRates() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/UAH');
                const data = await response.json();
                
                // –û–∫—Ä—É–≥–ª—è–µ–º –∫—É—Ä—Å—ã –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
                const usdRate = (1 / data.rates.USD).toFixed(2);
                const eurRate = (1 / data.rates.EUR).toFixed(2);
                const gbpRate = (1 / data.rates.GBP).toFixed(2);
                const plnRate = (1 / data.rates.PLN).toFixed(2);

                // –í—ã–≤–æ–¥–∏–º –∫—É—Ä—Å—ã –≤ —ç–ª–µ–º–µ–Ω—Ç —Å id "exchangeRates"
                const exchangeRatesElement = document.getElementById('exchangeRates');
                exchangeRatesElement.innerHTML = `
                    <div class="exchange-rates-block">
                        <p class="exchange-rate-item">1 USD = ${usdRate} –≥—Ä–Ω</p>
                        <p class="exchange-rate-item">1 EUR = ${eurRate} –≥—Ä–Ω</p>
                        <p class="exchange-rate-item">1 GBP = ${gbpRate} –≥—Ä–Ω</p>
                        <p class="exchange-rate-item">1 PLN = ${plnRate} –≥—Ä–Ω</p>
                    </div>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç:', error);
            }
        }

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
        const flipButton = document.getElementById('flipButton');
        const card = document.getElementById('card');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞
        flipButton.addEventListener('click', () => {
            card.classList.toggle('flipped'); // –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
        });

        let isCVVVisible = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ
        function toggleCVV() {
            const flipButtonText = document.getElementById("flipButtonText");

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
            if (isCVVVisible) {
                flipButtonText.textContent = "–ü–æ–∫–∞–∑–∞—Ç–∏ CVV"; // –ú–µ–Ω—è–µ–º –Ω–∞ "–ü–æ–∫–∞–∑–∞—Ç–∏ CVV"
            } else {
                flipButtonText.textContent = "–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ CVV"; // –ú–µ–Ω—è–µ–º –Ω–∞ "–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ CVV"
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ CVV
            isCVVVisible = !isCVVVisible;
        }

        // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', fetchExchangeRates);

        document.addEventListener('DOMContentLoaded', function() {
            const cardNumberElement = document.getElementById('cardNumber');
            const cardNumberFullElement = document.getElementById('cardNumberFull');

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ –Ω–æ–º–µ—Ä–∞
            function maskCardNumber(cardNumber) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—ã–µ 2 —Ü–∏—Ñ—Ä—ã, –∑–∞—Ç–µ–º 10 –∑–≤–µ–∑–¥ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã
                return cardNumber.slice(0, 2) + '**********' + cardNumber.slice(-4);
            }

            const cardNumber = '{{ card.card_number }}'; // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞

            // –ú–∞—Å–∫–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –Ω–∞ –ø–µ—Ä–µ–¥–Ω–µ–π —Å—Ç–æ—Ä–æ–Ω–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            cardNumberElement.textContent = maskCardNumber(cardNumber);

            // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–∞ –æ–±–æ—Ä–æ—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
            cardNumberFullElement.textContent = cardNumber;
        });

        document.addEventListener("DOMContentLoaded", function () {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
            function copyText(event) {
                const textToCopy = event.target.innerText;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å —Ç–µ–∫—Å—Ç–æ–º "–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!"
                    let message = document.createElement("span");
                    message.classList.add("copy-message");
                    message.innerText = "–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!";
                    event.target.appendChild(message);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    setTimeout(() => {
                        message.style.opacity = "1";
                    }, 50);

                    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        message.style.opacity = "0";
                        setTimeout(() => message.remove(), 300);
                    }, 3000);
                });
            }

            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç
            document.getElementById("exchangeRates").addEventListener("click", function (event) {
                if (event.target.classList.contains("exchange-rate-item")) {
                    copyText(event);
                }
            });
        });
    </script>
{% else %}
    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; text-align: left;">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828843.png" alt="–•—Ä–µ—Å—Ç" style="width: 50px; height: 50px; margin-right: 15px;">
        <h1 style="font-size: 30px; max-width: 500px; line-height: 1.4;">
            –û–π –ª–∏—Ö–æ, —Å—Ö–æ–∂–µ –≤–∞–º —Å–ø–æ—á–∞—Ç–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è... ü´£
        </h1>
    </div>
{% endif %}
{% endblock %}